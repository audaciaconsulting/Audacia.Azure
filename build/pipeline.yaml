name: $(Year:yy)$(DayOfYear).$(Rev:r)
trigger:
  - main
pr:
  branches:
    include:
      - main
resources:
  repositories:
    - repository: templates
      type: github
      ref: refs/heads/feature/204030-use-trusted-signing-for-assembly-signing
      endpoint: shared-github
      name: audaciaconsulting/Audacia.Build
pool:
  vmImage: windows-latest
variables:
  - group: Code Signing

stages:
  - stage: Stage_Build
    displayName: Build
    jobs:
      - template: src/build/dotnet/jobs/signed-nuget-package.job.yaml@templates
        parameters:
          projects: 'src/**/*.csproj'
          tests: 'tests/**/*.csproj'
          excludePaths: '*.Tests.csproj,Audacia.Azure.Demo.csproj'
          trustedSigningEndpoint: $(TrustedSigningEndpoint)
          trustedSigningAccount: $(TrustedSigningAccount)
          trustedSigningCertificateProfile: $(TrustedSigningCertificateProfile)
          directory: $(Build.SourcesDirectory)/Audacia.Random
          fileToSignPattern: 'Audacia.Random.dll'
          serviceConnection: 'Audacia Code Signing'

  - stage: Stage_Release
    displayName: Release
    dependsOn: Stage_Build
    condition: >
      and(
        succeeded(),
        notIn(variables['Build.Reason'], 'PullRequest', 'Schedule'),
        eq(dependencies.Stage_Build.outputs['Job_Build.UpdateVersions.ShouldPublish'], true)
      )
    jobs:
      - template: src/deployment/nuget/jobs/internal-public-nuget-package.job.yaml@templates
